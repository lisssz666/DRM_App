# DRM Sprayer Management System 部署文档

## 1. 项目打包

项目已成功打包，生成的jar文件路径：
```
d:\中广核\开发\项目\DRM_App\target\drm-sprayer-1.0.0.jar
```

## 2. CentOS服务器部署步骤

### 2.1 准备工作

确保CentOS服务器满足以下条件：
- Java 8或更高版本已安装
- 开放8080端口（或根据需要修改）
- 可访问MySQL数据库（114.132.162.213:3306）

### 2.2 安装Java环境

如果服务器未安装Java，执行以下命令：

```bash
# 更新yum源
sudo yum update -y

# 安装Java 11（推荐版本）
sudo yum install java-11-openjdk-devel -y

# 验证Java安装
java -version
javac -version
```

### 2.3 创建部署目录

```bash
# 创建应用部署目录
sudo mkdir -p /opt/drm-sprayer

# 设置权限
sudo chown -R $USER:$USER /opt/drm-sprayer
```

### 2.4 上传jar文件

使用scp命令将jar文件上传到服务器：

```bash
# 在本地执行该命令
scp target/drm-sprayer-1.0.0.jar <用户名>@<服务器IP>:/opt/drm-sprayer/
```
scp target/drm-sprayer-1.0.0.jar <root>@<47.251.245.247>:/opt/drm-sprayer/
D:\中广核\开发\项目\DRM_App\target

### 2.5 创建启动脚本

在服务器上创建启动脚本：

```bash
vi /opt/drm-sprayer/start.sh
```

脚本内容：

```bash
#!/bin/bash

# 应用名称
APP_NAME=drm-sprayer-1.0.0.jar

# 启动命令
nohup java -jar $APP_NAME > app.log 2>&1 &
echo "应用已启动，日志文件：app.log"
```

设置脚本权限：

```bash
chmod +x /opt/drm-sprayer/start.sh
```

### 2.6 配置systemd服务（推荐）

创建systemd服务文件，实现开机自启：

```bash
sudo vi /etc/systemd/system/drm-sprayer.service
```

服务文件内容：

```ini
[Unit]
Description=DRM Sprayer Management System
After=network.target

[Service]
User=root
WorkingDirectory=/opt/drm-sprayer
ExecStart=/usr/bin/java -jar /opt/drm-sprayer/drm-sprayer-1.0.0.jar
Restart=always
RestartSec=5s

[Install]
WantedBy=multi-user.target
```

重新加载systemd并启用服务：

```bash
# 重新加载systemd配置
sudo systemctl daemon-reload

# 启用开机自启
sudo systemctl enable drm-sprayer.service
```

### 2.7 启动应用

#### 使用systemd服务启动（推荐）：

```bash
# 启动服务
sudo systemctl start drm-sprayer.service

# 查看服务状态
sudo systemctl status drm-sprayer.service

# 查看日志
sudo journalctl -u drm-sprayer.service -f
```

#### 使用启动脚本启动：

```bash
cd /opt/drm-sprayer
./start.sh
```

### 2.8 验证部署

访问以下URL验证应用是否正常运行：

```
http://<服务器IP>:8080/api
```

## 3. 环境配置（可选）

### 3.1 修改数据库连接（如果需要）

如果需要修改数据库连接信息，可以在jar文件同级目录创建`application.yml`文件，覆盖默认配置：

```yaml
spring:
  datasource:
    url: jdbc:mysql://<新数据库IP>:3306/drm_sprayer?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=GMT%2B8
    username: <新用户名>
    password: <新密码>
```

### 3.2 修改端口（如果需要）

在`application.yml`中修改端口：

```yaml
server:
  port: <新端口>
```

## 4. 常见问题排查

### 4.1 端口被占用

```bash
# 查看端口占用情况
netstat -tlnp | grep 8080

# 终止占用端口的进程
kill -9 <PID>
```

### 4.2 数据库连接失败

- 检查数据库服务是否运行
- 检查数据库连接URL、用户名和密码
- 检查服务器网络是否能访问数据库服务器

### 4.3 应用启动失败

查看日志文件：
- 使用systemd：`sudo journalctl -u drm-sprayer.service`
- 使用脚本启动：`cat /opt/drm-sprayer/app.log`

## 5. 停止应用

#### 使用systemd服务停止：

```bash
sudo systemctl stop drm-sprayer.service
```

#### 使用进程ID停止：

```bash
# 查找进程ID
ps -ef | grep drm-sprayer

# 终止进程
kill -9 <PID>
```

## 6. 升级应用

1. 停止当前应用
2. 上传新的jar文件到服务器
3. 启动应用

---

**部署完成！** 应用将在服务器上运行，并可通过http://<服务器IP>:8080/api访问。